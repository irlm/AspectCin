<?xml version="1.0"?>
<project name="glassbox" basedir="." default="core">
	<property name="modules" value="bootstrap,monitor,agent,ltw13,webClient">
	</property>
	<property name="core-modules" value="bootstrap,monitor,agent,webClient">
	</property>
	<property name="agentModules" value="bootstrap,monitor,agent">
	</property>
	<target name="all" depends="init">
		<foreach list="${modules}" target="foreach-call" param="module-name">
			<param name="target" value="all"/>
		</foreach>
	</target>
    <target name="release" depends="init, clean, stamp, all, package"/>
    <target name="stamp">
        <buildnumber file="build.number"/>
        <propertyfile comment="Glassbox Build Information"
                  file="../dist/output/glassbox_build.properties">
            <entry key="build.date"
               type="date"
               pattern="EEEE MMM dd, yyyy"
               value="now"/>
            <entry key="build.time"
               type="date"
               pattern="kk:mm:ss"
               value="now"/>
            <entry key="build.timestamp"
               type="date"
               pattern="yyyy-MM-dd'T'HH:mm:ss"
               value="now"/>
            <entry key="build.number" value="2.0.${build.number}-BETA"/>
        </propertyfile>
    </target>
	<target name="core" depends="init">
		<foreach list="${core-modules}" target="foreach-call" param="module-name">
			<param name="target" value="all"/>
		</foreach>
	</target>
    <!-- should use a macrodef here -->
	<target name="package" depends="init">
        <patternset id="common.sources"
            includes=".*, build.*, *.xml, *.doc, *.txt, *.lic, .settings/**/*, src/**/*, ltwtestsrc/**/*, testsrc/**/*, java5-src/**/*, test/**/*, etc/**/*, doc/**/*, support/**/*, conf/**/*"
            excludes="**/mail.jar, **/activation.jar, **/java14Adapter.jar, **/build/*.build.properties, **/*.ajmap, **/*.ajproperties, **/Thumbs.db"/>
        <tstamp/>
        <delete>
            <fileset dir="${dist.dir}" includes="glassbox-src*.zip"/>
        </delete>   
        <zip destfile="${dist.dir}/glassbox-src.zip">            
            <zipfileset dir="../build" prefix="glassbox/build">
                <patternset refid="common.sources"/>            
            </zipfileset>
            <zipfileset dir="../agent" prefix="glassbox/agent">
                <patternset refid="common.sources" />
            </zipfileset>
            <zipfileset dir="../bootstrap" prefix="glassbox/bootstrap">
                <patternset refid="common.sources" />
            </zipfileset>
            <zipfileset dir="../monitor" prefix="glassbox/monitor">
                <patternset refid="common.sources" />
            </zipfileset>
            <zipfileset dir="../webClient" prefix="glassbox/webClient">
                <patternset refid="common.sources" />
                <patternset excludes="**/*.jar, **/*.class, web/images/**" includes="web/**" />
            </zipfileset>
            <zipfileset dir="../lib" prefix="glassbox">
                <patternset refid="common.sources" />
            </zipfileset>
            <zipfileset dir="../lib/Docs" prefix="glassbox" includes="Glassbox*2.0*.doc"/>
            <zipfileset dir="../ltw13" prefix="glassbox/ltw13">
                <patternset refid="common.sources" />
            </zipfileset>
        </zip>
        
        <patternset id="common.items"
            includes=".*, build.*, *.xml, *.doc, *.txt, *.lic, .settings/**/*, src/**/*, ltwtestsrc/**/*, java5-src/**/*, testsrc/**/*, etc/**/*, doc/**/*, support/**/*, **/*.jar, conf/**/*, installer/**/*"
            excludes="**/mail.jar, **/activation.jar, **/java14Adapter.jar, **/build/*.build.properties, **/*.ajmap, **/*.ajproperties, **/Thumbs.db"/>
		<zip destfile="${dist.dir}/glassbox-src-with-dependencies.zip" duplicate="fail" >
			<zipfileset dir="../build" prefix="glassbox/build">
                <patternset refid="common.items"/>            
			</zipfileset>
			<zipfileset dir="../agent" prefix="glassbox/agent">
				<patternset refid="common.items" />
			</zipfileset>
			<zipfileset dir="../bootstrap" prefix="glassbox/bootstrap">
				<patternset refid="common.items" />
			</zipfileset>
			<zipfileset dir="../monitor" prefix="glassbox/monitor">
				<patternset refid="common.items" />
			</zipfileset>
			<zipfileset dir="../webClient" prefix="glassbox/webClient">
				<patternset refid="common.items" />
    
				<patternset excludes="**/mail.jar, **/activation.jar, **/*.class" includes="web/**" />
			</zipfileset>
			<zipfileset dir="../lib" prefix="glassbox/lib" includes=".*, *.txt, **/*.jar" excludes="swt*/**"/>
            <zipfileset dir="../lib/Docs" prefix="glassbox" includes="Glassbox*2.0*.doc"/>
			<zipfileset dir="../ltw13" prefix="glassbox/ltw13">
				<patternset refid="common.items" />
			</zipfileset>
		</zip>        
	</target>
	<target name="rebuildCore" depends="cleanCore,core,deploy" />
	<target name="cleanCore" depends="init">
		<foreach list="${core-modules}" target="foreach-call" param="module-name">
			<param name="target" value="clean"/>
		</foreach>
	</target>
	<target name="clean" depends="init">
		<foreach list="${modules}" target="foreach-call" param="module-name">
			<param name="target" value="clean" />
		</foreach>
		<delete>
			<fileset dir="${dist.dir}" includes="*.jar" />
		</delete>
	</target>
	<target name="foreach-call">
		<ant dir="../${module-name}" target="${target}" />
	</target>
	<target name="jar" depends="init">
		<foreach list="${modules}" target="foreach-call" param="module-name">
			<param name="target" value="jar"/>
		</foreach>
	</target>
	<target name="coreJars" depends="init,buildCoreJars,deploy"/>
	<target name="buildCoreJars">
		<foreach list="${core-modules}" target="foreach-call" param="module-name">
			<param name="target" value="jar"/>
		</foreach>
	</target>
	<target name="deploy" depends="init">
		<ant dir="../monitor" target="deploy"/>
		<ant dir="../webClient" target="deploy"/>
	</target>
	<import file="common-tasks.xml"/>
</project>
