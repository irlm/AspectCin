<?xml version="1.0"?>

<!DOCTYPE project [
    <!ENTITY featuredeps SYSTEM "file:./featuredeps.xml">
]>

<!-- $Id: build.xml,v 1.32 2003/08/21 16:45:05 ravip Exp $ -->

<project name="facet" default="all" basedir="../../../../..">

   <!-- Specify location of the ajc and batch taskdefs -->
   <!--taskdef name="ajc" classname="org.aspectj.tools.ant.taskdefs.Ajc10"/-->

   <taskdef resource="org/aspectj/tools/ant/taskdefs/aspectjTaskdefs.properties">
   </taskdef>
   <taskdef name="batch" classname="edu.wustl.doc.ant.taskdefs.Batch"/>

   <!-- Include global platform property settings. -->
   <property name="platform.properties.file"
             value="${basedir}/platform.properties"/>
   <property file="${platform.properties.file}"/>

   <!-- Define some convenient properties that will be used later -->
   <property name="dirs.base" value="${basedir}"/>
   <property name="classdir" value="${dirs.base}/classes"/>
   <property name="classpath" value="${java.class.path}:${dirs.base}/classes"/>
   <property name="src" value="${dirs.base}/src"/>
   <property name="lib" value="${dirs.base}/lib"/>
   <property name="objdir" value="${dirs.base}/objs"/>
   <property name="gcjincludedir" value="${dirs.base}/include"/>
   <property name="statsdir" value="${dirs.base}/stats"/>
   <property name="include" value="${dirs.base}/idl"/>
   <property name="generated" value="${src}/generated"/>
   <property name="pkgoffset" value="edu/wustl/doc/facet"/>
   <property name="facetsrc" value="src/${pkgoffset}"/>
   <property name="facetdoc" value="doc/api"/>

   <property name="idl.includepath" value="generated_idl"/>
   <property name="idlflags" value="-I${facetsrc}/${idl.includepath} -d ${generated}"/>

   <property name="idl.EventComm" value="${idl.includepath}/EventComm.idl"/>
   <property name="idl.EventChannelAdmin" value="${idl.includepath}/EventChannelAdmin.idl"/>

   <!-- Include the feature dependence information -->
   &featuredeps;

   <!-- Choose everything needed to build the feature navigator -->
   <patternset id="featurefiles">
       <include name="${facetsrc}/**/*Feature*.java"/>
       <include name="${facetsrc}/feature/*.java"/>
       <include name="src/generated/${pkgoffset}/Event*/**.java"/>
   </patternset>

   <target name="all" depends="feature.selector, facet.lib, all.tests">
   </target>

   <target name="all.tests" depends="all.build" unless="no_unittests">
        <junit printsummary="on"
               fork="yes"
               haltonfailure="yes"
               timeout="30000">
          <classpath>
             <pathelement path="${java.class.path}" />
          </classpath>
          <jvmarg value="-Dorg.omg.CORBA.ORBClass=${org.omg.CORBA.ORBClass}"/>
          <jvmarg value="-Dorg.omg.CORBA.ORBSingletonClass=${org.omg.CORBA.ORBSingletonClass}"/>
          <test name="edu.wustl.doc.facet.AllTests"/>
          <formatter type="plain" usefile="no"/>
        </junit>
   </target>

   <target name="all.build"
           depends="feature.selector, feature.validation, ajc.build, jopt.facet, gcj.build">
   </target>

   <target name="feature.validation" depends="feature.validator.build">
        <java classname="edu.wustl.doc.facet.feature.FeatureValidator"
              classpath="${classpath}"
              fork="yes"
              failonerror="yes">
        </java> 
   </target>

  <target name="feature.validator.build">
        <iajc srcdir="${dirs.base}"
              destdir="${classdir}" Xlint="ignore">
             <patternset refid="feature.validator.srcfiles"/>
        </iajc>
   </target>
 
   <target name="ajc.build" depends="idl.compile">
	<iajc srcdir="${dirs.base}"
             destdir="${classdir}">
             <patternset refid="facet.srcfiles"/>
         </iajc>
   </target>

   <target name="feature.deps" depends="feature.framework.build">
        <java classname="edu.wustl.doc.facet.feature.FeatureDepBuilder"
              classpath="${classpath}"
              fork="yes"
              failonerror="yes">
              <arg line="${facetsrc}/featuredeps.xml"/>
        </java>
   </target>

   <target name="feature.graph" depends="feature.framework.build">
        <java classname="edu.wustl.doc.facet.feature.FeatureGraph"
              classpath="${classpath}"
              fork="yes"
              failonerror="yes">
              <arg line="features.dot"/>
        </java>
        <exec executable="dot">
              <arg line="-Tps features.dot -o features.ps"/>
        </exec>
        <exec executable="dot">
              <arg line="-Tsvg features.dot -o features.svg"/>
        </exec>
   </target>

   <target name="feature.framework.build">
	<iajc srcdir="${dirs.base}"
             destdir="${classdir}" Xlint="ignore">
             <patternset refid="featurefiles"/>
         </iajc>
   </target>

   <target name="idl.compile" 
           depends="eventcomm.idl.compile, eventchanneladmin.idl.compile" unless="use_feature_disable_corba">
   </target>

   <target name="eventcomm.idl.compile" depends="idl.generation" unless="use_feature_disable_corba">
        <java classname="org.jacorb.idl.parser"
              classpath="${classpath}"
              fork="yes"
              failonerror="yes">
              <arg line="${idlflags} ${facetsrc}/${idl.EventComm}"/>

        </java>
   </target>

   <target name="eventchanneladmin.idl.compile" depends="idl.generation" unless="use_feature_disable_corba">
        <java classname="org.jacorb.idl.parser"
              classpath="${classpath}"
              fork="yes"
              failonerror="yes">
              <arg line="${idlflags} ${facetsrc}/${idl.EventChannelAdmin}"/>
        </java>
   </target>

   <target name="idl.generation" depends="idl.generator.build" unless="use_feature_disable_corba">
        <java classname="edu.wustl.doc.facet.IdlGenerator"
              classpath="${classpath}"
              fork="yes"
              failonerror="yes">
              <arg line="${facetsrc}/${idl.includepath}/"/>
        </java>
   </target>

  <target name="aspect.introduction">
        <iajc srcdir="${dirs.base}"
             destdir="${classdir}" Xlint="ignore">
             <patternset refid="aspect.introduction.srcfiles"/>
        </iajc>
   </target>

   <!-- Files needed to build the IdlGenerator -->
   <patternset id="idl.generator.srcfiles">
       <include name="${facetsrc}/IdlGenerator.java"/>
   </patternset>

   <target name="idl.generator.build" depends="aspect.introduction">
      	<iajc srcdir="${dirs.base}"
             destdir="${classdir}" Xlint="ignore">
           <patternset refid="idl.generator.srcfiles"/>
         </iajc>
   </target>

   <target name="doc" depends="feature.selector">
        <mkdir dir="${facetdoc}"/>
        <fileset dir="${dirs.base}" id="ajdoc.src.files">
             <patternset refid="facet.srcfiles"/>
        </fileset>
        <pathconvert pathsep=" " property="ajdoc.file.list" refid="ajdoc.src.files"/>
        <java classname="org.aspectj.tools.ajdoc.Main"
              classpath="${jdk.tools};${java.class.path}"
              fork="yes">
              <arg line="-group Base edu.wustl.doc.facet"/>
              <arg line="-group FeatureManagement edu.wustl.doc.facet.feature"/>
              <arg line="-group EventChannelAdmin edu.wustl.doc.facet.EventChannelAdmin"/>
              <arg line="-group EventComm edu.wustl.doc.facet.EventComm"/>
              <arg line="-windowtitle FACET"/>
              <arg line="-author -version"/>
              <arg line="-d ${facetdoc} ${ajdoc.file.list}"/>
        </java>
   </target>

   <target name="facet.lib" depends="all.build">
      <jar jarfile="${lib}/facet.jar"
           basedir="${classdir}"
           includes="${pkgoffset}/**,edu/wustl/doc/utils/**"/>
   </target>

   <!-- GCJ related targets -->

   <target name="gcj.build" if="usegcj"
           depends="gcj.facet.lib" unless="use_feature_enable_corba">
      <antcall target="gcj.facetexe"/>
      <antcall target="gcj.headers"/>
   </target>

   <target name="gcj.facetexe" if="usegcj" depends="gcj.facetexe.tests, gcj.facetexe.notests">
   </target>

   <!-- Pseudo runnable to be able to measure the FACET library
        size without any unittests.
        Note that all .o files are statically linked so the linker
        shouldn't exclude anything in FACET due to no references
        from main. -->
   <target name="gcj.facetexe.notests"
           if="no_unittests">
        <echo message="Building no unit test executable..."/>
        <apply executable="gcj"
               dest="${lib}"
               parallel="true"
               failonerror="yes">
          <arg value="-g"/>
          <arg value="--main=edu.wustl.doc.facet.feature.FeatureGraph"/>
          <arg value="-L${lib}"/>
          <arg value="-Wl,-rpath"/>
          <arg value="-Wl,${lib}"/>
          <srcfile/>
          <arg value="-laspectjrt"/>
          <!--arg value="-llog4j"/-->
          <arg value="-o"/>
          <targetfile/>
          <fileset dir="${objdir}" includes="${pkgoffset}/**/*.o"/>
          <mapper type="merge" to="facet"/>
        </apply>
   </target>

   <target name="gcj.facetexe.tests"
           if="usegcj" unless="no_unittests">
        <echo message="Building unit test executable..."/>
        <apply executable="gcj"
               dest="${lib}"
               parallel="true" skipemptyfilesets="true"
               failonerror="yes">
          <arg value="-shared"/>
          <arg value="-g"/>
          <arg value="--main=edu.wustl.doc.facet.AllTests"/>
          <arg value="-L${lib}"/>
          <arg value="-Wl,-rpath"/>
          <arg value="-Wl,${lib}"/>
          <arg value="-lutils"/>
          <arg value="-ljunit"/>
          <arg value="-laspectjrt"/>
          <!--arg value="-llog4j"/-->
          <srcfile/>
          <arg value="-o"/>
          <targetfile/>
          <fileset dir="${objdir}" includes="${pkgoffset}/**/*.o"/>
          <mapper type="merge" to="facet"/>
        </apply>
   </target>

   <target name="gcj.facet.lib" depends="gcj.obj.build" if="usegcj" 
           unless="use_feature_enable_corba">
        <apply executable="gcc"
               dest="${lib}"
               parallel="true"
               failonerror="yes">
          <arg value="-shared"/>
          <arg value="-o"/>
          <targetfile/>
          <srcfile/>
          <fileset dir="${objdir}" includes="${pkgoffset}/**/*.o"/>
          <mapper type="merge" to="libfacet.so"/>
        </apply>
   </target>

   <target name="gcj.obj.build" depends="ajc.build" if="usegcj" 
           unless="use_feature_enable_corba">
        <mkdir dir="${objdir}/${pkgoffset}"/>
        <apply executable="${python2.executable}"
               dest="${objdir}"
               parallel="true"
               failonerror="yes">
           <arg value="${facetsrc}/scripts/maketargetdirs.py"/>
           <targetfile/>
           <fileset dir="classes" includes="${pkgoffset}/**/*.class"/>
           <mapper type="glob" from="*.class" to="*.o"/>
        </apply>

        <apply executable="gcj"
               dest="${objdir}"
               parallel="false"
               failonerror="yes">
          <arg value="-O3"/>
          <arg value="-g"/>
          <arg value="-c"/>
          <arg value="-o"/>
          <targetfile/>
          <srcfile/>
          <fileset dir="classes" includes="${pkgoffset}/**/*.class"/>
          <mapper type="glob" from="*.class" to="*.o"/>
        </apply>
   </target>

   <target name="gcj.headers" if="usegcj">
    <exec executable="gcjh"
     	  failonerror="yes">
      <arg line="-d ${gcjincludedir}"/>
      <arg value="edu.wustl.doc.facet.EventChannelImpl"/>
      <arg value="edu.wustl.doc.facet.EventChannelBase"/>
      <arg value="edu.wustl.doc.facet.PushConsumerBase"/>
      <arg value="edu.wustl.doc.facet.PullConsumerBase"/>
      <arg value="edu.wustl.doc.facet.ProxyPushConsumerBase"/>
      <arg value="edu.wustl.doc.facet.ProxyPullConsumerBase"/>
      <arg value="edu.wustl.doc.facet.ProxyPushSupplierBase"/>
      <arg value="edu.wustl.doc.facet.ProxyPullSupplierBase"/>
      <arg value="edu.wustl.doc.facet.ConsumerAdminBase"/>
      <arg value="edu.wustl.doc.facet.SupplierAdminBase"/>
      <arg value="edu.wustl.doc.facet.EventChannelPushConsumer"/>
      <arg value="edu.wustl.doc.facet.EventComm.PushConsumer"/>
      <arg value="edu.wustl.doc.facet.EventComm.PullConsumer"/>
      <arg value="edu.wustl.doc.facet.EventComm.PushSupplier"/>
      <arg value="edu.wustl.doc.facet.EventComm.PullSupplier"/>
      <arg value="edu.wustl.doc.facet.EventComm.Event"/>
      <arg value="edu.wustl.doc.facet.EventComm.EventHeader"/>

      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.EventChannel"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.SupplierAdmin"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.ConsumerAdmin"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.ProxyPushConsumer"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.ProxyPullConsumer"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.ProxyPushSupplier"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.ProxyPullSupplier"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.Dependency"/>
      <arg
           value="edu.wustl.doc.facet.EventChannelAdmin.ConsumerQOS"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.FilterOpTypes"/>
      <arg
	   value="edu.wustl.doc.facet.EventChannelAdmin.EventChannelException"/>
    </exec>
   </target>


   <!-- Optimize the class files generated by ajc or javac
        to remove debug information, compact the constant pool
        and perform some optimizations on the bytecodes
         
        We use JOpt to do the job -->
   
   <target name="jopt.facet" depends="ajc.build" if="usejopt">
        <!-- Delete any old optimized class files -->
        <delete>
           <fileset dir="${classdir}" includes="${pkgoffset}/**/*_o.class"/>
        </delete>

        <!-- Optimize... -->
        <echo message="Running Jopt..."/>
        <batch executable="java"
               dir="${classdir}"
               parallel="true"
               parallelamount="100">
           <arg value="Jopt"/>
           <arg value="-silent"/>
           <fileset dir="${classdir}" includes="${pkgoffset}/**/*.class"/>
        </batch>

        <!-- Remove the _o from the generated files. -->
        <move todir="${classdir}/${pkgoffset}">
           <fileset dir="${classdir}/${pkgoffset}">
             <include name="**/*_o.class"/>
           </fileset>
           <mapper type="glob" from="*_o.class" to="*.class"/>
        </move>
   </target>

   <target name="realclean" depends="clean">
           <delete dir="${facetdoc}"/>
   </target>

   <target name="clean">
           <delete dir="${classdir}/${pkgoffset}"/>
           <delete dir="${ajworkingdir}/${pkgoffset}"/>
           <delete dir="${generated}/${pkgoffset}"/>
           <delete dir="${objdir}/${pkgoffset}"/>
           <delete file="${lib}/libfacet.so"/>
           <delete file="${lib}/facet"/>
           <delete file="${lib}/facet.jar"/>
           <delete file="${facetsrc}/${idl.EventComm}"/>
           <delete file="${facetsrc}/${idl.EventChannelAdmin}"/>
           <delete>
             <fileset dir="." defaultexcludes="no" includes="${facetsrc}/**/.ajsline"/>
             <fileset dir="." defaultexcludes="no" includes="${facetsrc}/**/.ajdbErrors"/>
             <fileset dir="." defaultexcludes="no" includes="${facetsrc}/**/*.ajsym"/>
             <fileset dir="." includes="${facetsrc}/**/*.bak"/>
             <fileset dir="." defaultexcludes="no" includes="${facetsrc}/**/*~"/>
           </delete>
   </target>

   <target name="testall.everything" depends="clean, all.build, all.stats,all.tests"/>

   <target name="testall.everything.checkfirst"
           depends="testall.everything.executor"/>

   <target name="testall.everything.checker" depends="stats.init">
     <available file="${stats}/classfilesize.${facet.run.config}"
                property="testall.everything.dontexecute"/>
   </target>

   <target name="testall.everything.executor"
           depends="testall.everything.checker"
           unless="testall.everything.dontexecute">
      <antcall target="testall.everything"/>
   </target>

   <!--+
       |
       | Stats collection targets
       |
       +-->
   <target name="stats.init" depends="stats.check.run.properties">
     <property name="stats" value="${statsdir}/${facet.run.name}"/>
     <mkdir dir="${stats}"/>
   </target>

   <target name="stats.check.run.properties" unless="facet.run.config">
     <echo message="facet.run.config undefined.  Using default names."/>
     <property name="facet.run.name" value="test"/>
     <property name="facet.run.config" value="unknown"/>
   </target>

   <target name="all.stats"
           depends="stats.init, stats.gcj.size, stats.classfile.size,stats.throughput">
   </target>

   <target name="stats.gcj.size" depends="stats.init, gcj.facet.lib" if="usegcj">
     <exec dir="${stats}" executable="size"
           output="${stats}/gcjsize.${facet.run.config}">
       <arg line="${lib}/libfacet.a"/>
     </exec>
     <exec dir="${stats}" executable="size"
           output="${stats}/gcjaoutsize.${facet.run.config}">
       <arg line="${lib}/facet"/>
     </exec>
   </target>

   <target name="stats.classfile.size" depends="stats.init, all.build">
     <exec dir="${dirs.base}" executable="${python2.executable}"
           output="${stats}/classfilesize.${facet.run.config}">
       <arg line="${facetsrc}/scripts/classfilestats.py ${classdir}/${pkgoffset}"/>
     </exec>
   </target>

   <target name="stats.throughput" depends="stats.init, all.build" if="use_throughput_test">
        <!-- Set FACET.tracing if not already set -->
        <property name="FACET.tracing" value="disabled"/>
        <exec executable="java"
              timeout="120000"
              output="${stats}/throughput.${facet.run.config}">
          <arg value="-Dorg.omg.CORBA.ORBClass=${org.omg.CORBA.ORBClass}"/>
          <arg value="-Dorg.omg.CORBA.ORBSingletonClass=${org.omg.CORBA.ORBSingletonClass}"/>
          <arg value="-DFACET.tracing=${FACET.tracing}"/>
          <arg value="junit.textui.TestRunner"/>
          <arg value="edu.wustl.doc.facet.throughput_test.ThroughputTestCase"/>
        </exec>
   </target>


 </project>
