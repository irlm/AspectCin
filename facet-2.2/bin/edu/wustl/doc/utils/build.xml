<?xml version="1.0"?>

<project name="utils" default="all" basedir="../../../../..">

   <!-- Include global platform property settings. -->
   <property name="platform.properties.file"
             value="${basedir}/platform.properties"/>
   <property file="${platform.properties.file}"/>

   <!-- Define some convenient properties that will be used later -->
   <property name="dirs.base" value="${basedir}"/>
   <property name="src" value="${dirs.base}/src"/>
   <property name="classdir" value="${dirs.base}/classes"/>
   <property name="objdir" value="${dirs.base}/objs"/>
   <property name="libdir" value="${dirs.base}/lib"/>
   <property name="include" value="${dirs.base}/idl"/>
   <property name="generated" value="${src}/generated"/>
   <property name="idlflags" value="-d ${generated}"/>
   <property name="pkgoffset" value="edu/wustl/doc/utils"/>

   <property name="libname" value="libutils.so"/>

   <target name="all" depends="javac.build, gcj.build">
   </target>

   <target name="javac.build" depends="all.preprocess">
	<javac destdir="${classdir}">
           <src path="${src}"/>
           <src path="${src}/generated"/>
           <include name="${pkgoffset}/*.java"/>
        </javac>
   </target>

   <target name="gcj.build" depends="javac.build" if="usegcj">
        <mkdir dir="${objdir}/${pkgoffset}"/>
        <apply executable="gcj" dest="${objdir}" 
               parallel="false" failonerror="true" skipemptyfilesets="true">
          <arg value="-O3"/>
          <arg value="-c"/>
          <arg value="-o"/>
          <targetfile/>
          <srcfile/>
          <fileset dir="${src}" includes="${pkgoffset}/*.java"
                                excludes="${pkgoffset}/ServerKillerImpl.java"/>
          <mapper type="glob" from="*.java" to="*.o"/>
        </apply>

        <apply executable="gcj" dest="${libdir}" parallel="true" 
               skipemptyfilesets="true">
          <arg value="-shared"/>
          <arg value="-o"/>
          <targetfile/>
          <srcfile/>
          <fileset dir="${objdir}" includes="${pkgoffset}/*.o"/>
          <mapper type="merge" to="${libname}"/>
        </apply>
   </target>

   <target name="all.preprocess" depends="idl.serverkiller">
   </target>

   <target name="idl.serverkiller">
        <java classname="org.jacorb.idl.parser"
              classpath="${classpath}"
              fork="yes">
              <arg line="${idlflags} src/${pkgoffset}/ServerKiller.idl"/>
        </java>
   </target>

   <target name="clean">
	   <delete dir="${classdir}/${pkgoffset}"/>
           <delete dir="${generated}/${pkgoffset}"/>
           <delete dir="${ajworkingdir}/${pkgoffset}"/>
           <delete dir="${objdir}/${pkgoffset}"/>
           <delete file="${libdir}/${libname}"/>
           <delete>
             <fileset dir="." defaultexcludes="no" includes="src/${pkgoffset}/**/.ajsline"/>
             <fileset dir="." defaultexcludes="no" includes="src/${pkgoffset}/**/.ajdbErrors"/>
             <fileset dir="." defaultexcludes="no" includes="src/${pkgoffset}/**/*.ajsym"/>
             <fileset dir="." includes="src/${pkgoffset}/**/*.bak"/>
             <fileset dir="." defaultexcludes="no" includes="src/${pkgoffset}/**/*~"/>
           </delete>
   </target>

</project>
